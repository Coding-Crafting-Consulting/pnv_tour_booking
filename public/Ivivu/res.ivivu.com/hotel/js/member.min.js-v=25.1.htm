var loginForm=$('#loginForm');var registerForm=$('#registerForm');var apiUrl=Static.rootGate();loginForm.submit(function(e){e.preventDefault();var emailOrPhone=loginForm.find('input[name="EmailPhoneDN"]').val();var pass=loginForm.find('input[name="PasswordDN"]').val();var isRedirectMember=loginForm.find('input[name="IsRedirectMember"]').val();const apiData={EmailOrPhone:emailOrPhone,Password:pass};$.ajax({type:'POST',url:apiUrl+'api/Account/Login',data:JSON.stringify(apiData),processData:!1,contentType:"application/json; charset=utf-8",success:function(data){var resToken=data.auth_token;document.cookie="auth_token="+resToken+";path=/;domain="+getCookieDomain();watchToken();if(isRedirectMember==="true"){window.location.href="https://member.ivivu.com/dashboard/rewards"}
else{getUserHeader();$('#LoginModal').modal("hide")}},error:function(data){if(data.responseJSON===undefined)
loginForm.find('.errorMsg').text("Không thể kết nối đến máy chủ !");if(data.responseJSON.msg!==undefined)
loginForm.find('.errorMsg').text(data.responseJSON.msg)},})});registerForm.submit(function(e){e.preventDefault();var checkboxPolicy=registerForm.find('input[name="policy-checkbox"]').prop('checked');if(!checkboxPolicy){registerForm.find('.errorMsg').text('Bạn phải đồng ý với điều khoản của iVIVU !')}
else{var email=registerForm.find('input[name="EmailDK"]').val();var pass=registerForm.find('input[name="PasswordDK"]').val();var pass2=registerForm.find('input[name="RePasswordDK"]').val();const apiData={Email:email,Password:pass,Password2:pass2};$.ajax({type:'POST',url:apiUrl+'api/Account/Register',data:JSON.stringify(apiData),processData:!1,contentType:"application/json; charset=utf-8",success:function(data){var resToken=data.auth_token;document.cookie="auth_token="+resToken+";path=/;domain="+getCookieDomain();watchToken();getUserHeader();$('#RegisterModal').modal("hide");$('#LoginModal').modal("show")},error:function(data){if(data.responseJSON===undefined)
loginForm.find('.errorMsg').text("Không thể kết nối đến máy chủ !");if(data.responseJSON.msg!==undefined)
registerForm.find('.errorMsg').text(data.responseJSON.msg)},})}});function getCookie(cname){var name=cname+"=";var decodedCookie=decodeURIComponent(document.cookie);var ca=decodedCookie.split(';');for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)===' '){c=c.substring(1)}
if(c.indexOf(name)===0){return c.substring(name.length,c.length)}}
return""}
function getCookieDomain(){if(document.location.hostname==="localhost")
return document.location.hostname;else return"ivivu.com"}
function logoutUser(){var token=getCookie('auth_token');$.ajax({type:'GET',url:apiUrl+'api/Account/Logout',contentType:"application/json; charset=utf-8",beforeSend:function(xhr){xhr.setRequestHeader('Authorization','Bearer '+token)},success:function(data){document.cookie="auth_token=;path=/;domain="+getCookieDomain();watchToken();getUserHeader()},error:function(data){document.cookie="auth_token=;path=/;domain="+getCookieDomain();watchToken();getUserHeader()},})}
var showRegisterDialog=function(){registerForm.find('.errorMsg').text('');registerForm.find('input[name="EmailDK"]').val('');registerForm.find('input[name="PasswordDK"]').val('');registerForm.find('input[name="RePasswordDK"]').val('');registerForm.find('input[name="policy-checkbox"]').prop("checked",!1);$("#RegisterModal").modal()}
var showLoginDialog=function(){loginForm.find('.errorMsg').text('');loginForm.find('input[name="EmailPhoneDN"]').val('');loginForm.find('input[name="PasswordDN"]').val('');$("#LoginModal").modal()}
function getUserHeader(){var headerLogin;var token=getCookie('auth_token');if(token!==null&&token!==""){setTimeout(function(){if($("#hdhdhdhhdhdhdhdhdhd").val()!==''){Common.logout()}},1000)
$.ajax({type:'GET',url:apiUrl+'api/Dashboard/Getuserinfo',contentType:"application/json; charset=utf-8",beforeSend:function(xhr){xhr.setRequestHeader('Authorization','Bearer '+token)},success:function(data){headerLogin=$("#UserLogged").html();$("#UserLogin .user-menu-list").html(headerLogin);$("#UserLogin .username-header").html(getShortName(data.fullname));var avatarUrl=data.avatar;$("#UserLogin img.img-circle").attr("src",avatarUrl);$("#UserLogin .userMail-header").text(data.email);$("#UserLogin .userPoint-header").text(numberStr(data.point))},error:function(data){headerLogin=$("#UserNotLogged").html();$("#UserLogin .user-menu-list").html(headerLogin);$("#UserLogin .username-header").html("Tài khoản");$("#UserLogin img.img-circle").attr("src",$("#UserLogin img.img-circle").data("src"))},})}
else{headerLogin=$("#UserNotLogged").html();$("#UserLogin .user-menu-list").html(headerLogin);$("#UserLogin .username-header").html("Tài khoản");$("#UserLogin img.img-circle").attr("src",$("#UserLogin img.img-circle").data("src"))}}
getUserHeader();function create_UUID(){var dt=new Date().getTime();var uuid='xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=(dt+Math.random()*16)%16|0;dt=Math.floor(dt/16);return(c==='x'?r:(r&0x3|0x8)).toString(16)});return uuid}
function watchToken(){document.getElementById('token_change').value=create_UUID();document.body.click()}
watchToken();function numberStr(number){if(number===undefined)
return'undefined';var parts=number.toString().split(".");parts[0]=parts[0].replace(/\B(?=(\d{3})+(?!\d))/g,",");return parts.join(".")}
function checkAvatarURL(avatarUrl){if(avatarUrl!==null){if(avatarUrl.startsWith("http://")||avatarUrl.startsWith("https://"))
return avatarUrl;else return this.avatarFolderUrl+"/"+avatarUrl}
else return avatarUrl}
function getShortName(fullname){if(fullname!==null){if(fullname.match(/[a-z0-9._%+-]+@Html.Raw("@[a-z0-9.-]")+\.[a-z]{2,3}$/g))
return fullname.split("@Html.Raw('@')")[0];else return fullname.split(" ").pop().replace(/[&\/\\#,+()$~%.'":*?<>{}]/g,'')}}
window.fbAsyncInit=function(){FB.init({appId:'628025334278848',autoLogAppEvents:!0,xfbml:!0,version:'v3.2',status:!1,cookie:!1,})};var socialUser={userData:{email:"",name:"",id:"",image:"",provider:"",token:"",idToken:""}};function loginByFacebook(){window.fbAsyncInit();socialUser.userData.provider="facebook";FB.login(function(response){FB.getLoginStatus(function(response){if(response.status==='connected'){socialUser.userData.token=response.authResponse.accessToken;FB.api('/me','GET',{"fields":"id, name, email"},function(response){socialUser.userData.name=response.name;socialUser.userData.id=response.id;socialUser.userData.image='https://graph.facebook.com/'+response.id+'/picture?type=large';socialUser.userData.email=response.email;if(socialUser.userData.email===''||socialUser.userData.email===null||socialUser.userData.email===undefined){$.ajax({type:'POST',url:apiUrl+'api/account/CheckSocialNoEmail',data:JSON.stringify(socialUser),processData:!1,contentType:"application/json; charset=utf-8",success:function(data){if(!data.result){$('.close-modal-button').click();$("#GetSocialModal").modal()}
else{checkValidUser(socialUser,function(data){loginSocial(socialUser)})}},error:function(data){if(data.responseJSON.msg!==undefined)
loginForm.find('.errorMsg').text(data.responseJSON.msg)},})}
else{checkValidUser(socialUser,function(data){loginSocial(socialUser)})}})}else{loginForm.find('.errorMsg').text('Login tài khoản Facebook không thành công !')}})})}
var googleUser={};var startApp=function(){gapi.load('auth2',function(){auth2=gapi.auth2.init({client_id:'375816142694-o1h018pafnfnb7uacd1uvekddg29m10i.apps.googleusercontent.com',});attachSignin(document.getElementById('loginGoogleButton'));attachSignin(document.getElementById('registerGoogleButton'))})};function attachSignin(element){auth2.attachClickHandler(element,{},function(googleUser){var profile=googleUser.getBasicProfile();socialUser.userData.provider="google";socialUser.userData.id=profile.Eea;socialUser.userData.email=profile.getEmail();socialUser.userData.name=profile.getName();socialUser.userData.image=profile.getImageUrl();socialUser.userData.idToken=googleUser.getAuthResponse().id_token;loginSocial(socialUser)},function(error){loginForm.find('.errorMsg').text('Login tài khoản Google không thành công !')})}
startApp();function getSocialEmail(){if(document.getElementById("socialEmail")!==undefined){socialUser.userData.email=document.getElementById("socialEmail").value;loginSocial(socialUser)}}
function loginSocial(user){var isRedirectMember=loginForm.find('input[name="IsRedirectMember"]').val();$.ajax({type:'POST',url:apiUrl+'api/account/socialLogin',data:JSON.stringify(user),processData:!1,contentType:"application/json; charset=utf-8",success:function(data){var resToken=data.auth_token;document.cookie="auth_token="+resToken+";path=/;domain="+getCookieDomain();if(isRedirectMember==="true")
window.location.href="https://member.ivivu.com/dashboard/rewards";else{watchToken();getUserHeader();$('#LoginModal').modal("hide");$('#RegisterModal').modal("hide");$("#GetSocialModal").modal("hide")}},error:function(data){if(data.responseJSON.msg!==undefined){$("#GetSocialModal").find('.errorMsg').empty().text(data.responseJSON.msg);loginForm.find('.errorMsg').text(data.responseJSON.msg);registerForm.find('.errorMsg').text(data.responseJSON.msg)}},})}
function checkValidUser(user,callback){$.ajax({type:'POST',url:apiUrl+'api/account/checkValidUser',data:JSON.stringify(user),processData:!1,contentType:"application/json; charset=utf-8",success:function(data){if(callback!==undefined){if(data.result){$('.close-modal-button').click();$("#GetValidUser").modal()}
else callback(data)}},error:function(data){if(data.responseJSON.msg!==undefined){$("#GetValidUser").find('.errorMsg').empty().text(data.responseJSON.msg)}},})}
function mapPhoneOrEmail(){if(document.getElementById("emailOrPhone")!==undefined){var emailOrPhone=document.getElementById("emailOrPhone").value;GetSocialModal
$.ajax({type:'POST',url:apiUrl+'api/account/MapUserByEmailOrPhone',data:JSON.stringify({userData:socialUser.userData,EmailOrPhone:emailOrPhone}),processData:!1,contentType:"application/json; charset=utf-8",success:function(data){loginSocial(socialUser);$('.close-modal-button').click()},error:function(data){},})}}
function fillInfoToForm(arr){try{var token=getCookie('auth_token');$.ajax({type:'GET',url:apiUrl+'api/Dashboard/Getuserinfo',contentType:"application/json; charset=utf-8",beforeSend:function(xhr){xhr.setRequestHeader('Authorization','Bearer '+token)},success:function(data){if(data){for(var i=0;i<arr.length;i++){if(arr[i].type==='input'){if(arr[i].mapto==="name")
$(arr[i].element).val(data.fullname);if(arr[i].mapto==="email")
$(arr[i].element).val(data.email);if(arr[i].mapto==="phone")
$(arr[i].element).val(data.phone)}}}},error:function(data){},})}
catch(err){}}
function afterUserLogged(successFuc,failFunc){try{var token=getCookie('auth_token');if(token===null||token===""){if(failFunc){failFunc()}
return!1}
$.ajax({type:'GET',url:apiUrl+'api/Dashboard/Getuserinfo',contentType:"application/json; charset=utf-8",beforeSend:function(xhr){xhr.setRequestHeader('Authorization','Bearer '+token)},success:function(data){if(data&&successFuc){successFuc(data)}
else{if(failFunc){failFunc()}}},error:function(data){if(failFunc){failFunc()}
return!1},})}
catch(err){if(failFunc){failFunc()}
return!1}}